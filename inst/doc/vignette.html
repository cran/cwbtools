<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Andreas Blätte (andreas.blaette@uni-due.de)" />

<meta name="date" content="2024-02-26" />

<title>Introducing ‘cwbtools’</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Introducing ‘cwbtools’</h1>
<h4 class="author">Andreas Blätte (<a href="mailto:andreas.blaette@uni-due.de" class="email">andreas.blaette@uni-due.de</a>)</h4>
<h4 class="date">2024-02-26</h4>



<div id="using-the-cwbtools-package" class="section level1">
<h1>Using the ‘cwbtools’ package</h1>
<p>The <em>cwbtools</em> package offers a toolset to create, modify and
manage corpora to be used with the Corpus Workbench (CWB) from within R.
It supports the transition from data formats established by well-known R
packages such as <a href="https://CRAN.R-project.org/package=tm">tm</a>,
<a href="https://CRAN.R-project.org/package=quanteda">quanteda</a> or <a href="https://CRAN.R-project.org/package=tidytext">tidytext</a> to a CWB
corpus, so that the CWB data format and CWB-related tools can be
used.</p>
<p>Working with CWB indexed corpora is worth considering when working
with large corpora. The <em>cwbtools</em> package is designed to be able
to work with large data. The core tool of the cwbtools package is the
<code>CorpusData</code>-Class. It offers a standard workflow to import
and process data, and to generate an indexed corpus. It is implemented
as a <a href="https://adv-r.hadley.nz/r6.html">R6 class</a>. The
advantage of using the reference semantics of the R6 class system is
that there is minimal copying of the data. Handling memory
parsimoniously is necessary when working with large corpora.</p>
<p>Further functions of the package support the creation, modification
and management of structural and positional attributes of a corpus, and
of registry files. See the manual to learn more about these functions.
To learn more about the data structure of the CWB and the CWB jargon,
the <a href="https://cwb.sourceforge.io/files/CWB_Encoding_Tutorial.pdf">IMS
Open Corpus Workbench (CWB) Corpus Encoding Tutorial</a> is recommended
as a point of entry.</p>
<p>The focus of this vignette is the creation of CWB indexed corpora. We
present three scenarios: Creating a corpus (a) from a
<code>tibble</code>, (b) from XML and (c) from the <code>VCorpus</code>
used by the tm package.</p>
<p>We start with a few preliminary preparations.</p>
<div id="getting-started" class="section level2">
<h2>Getting Started</h2>
<p>The CWB stores each indexed corpora in an individual data directory.
Registry files in a ‘registry directory’ (or ‘registry’ in short)
describe the indexed corpora and include the path to the data
directory.</p>
<p>For the following examples, we create a temporary directory structure
for registry files, and indexed corpora, making sure that these
directories exits and are empty.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>registry_tmp <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;registry&quot;</span>)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>data_dir_tmp <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(<span class="fu">tempdir</span>(), <span class="st">&quot;data_dir&quot;</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(registry_tmp)){</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="fu">dir.create</span> (registry_tmp)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">file.remove</span>(<span class="fu">list.files</span>(registry_tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>}</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(data_dir_tmp)) <span class="fu">dir.create</span>(data_dir_tmp)</span></code></pre></div>
<p>In addition to <em>cwbtools</em>, we rely extensively on the <a href="https://CRAN.R-project.org/package=data.table">data.table</a>
package. It is a good companion to <em>cwbtools</em> because of its
efficiency to handle large data. Apart from the processing speed, it
supports in-place modifications of data. When corpora grow large, it is
advisable to omit copying the data in memory if not absolutely
necessary.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">library</span>(cwbtools)</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="fu">library</span>(data.table)</span></code></pre></div>
<p>Core operations on structural and positional attributes are
implemented in “pure R”, but the CWB can be downloaded and stored within
the package using the <code>cwb_install()</code> function. In the
following examples, we will rely on the “pure R” approach.</p>
<div id="scenario-1-tidytext-to-cwb" class="section level3">
<h3>Scenario 1: Tidytext to CWB</h3>
<p>As a basic scenario, we create a corpus of Jane Austen’s books
(included in the package <a href="https://CRAN.R-project.org/package=janeaustenr">janeaustenr</a>).
We first create an (empty) data directory …</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>austen_data_dir_tmp <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(data_dir_tmp, <span class="st">&quot;austen&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(austen_data_dir_tmp)) <span class="fu">dir.create</span>(austen_data_dir_tmp)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="fu">file.remove</span>(<span class="fu">list.files</span>(austen_data_dir_tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<p>… and instantiating a <code>CorpusData</code> object.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>Austen <span class="ot">&lt;-</span> CorpusData<span class="sc">$</span><span class="fu">new</span>()</span></code></pre></div>
<p>The <code>tidytext</code> package offers an efficient workflow to
create the token stream we can assign to the <code>CorpusData</code>
object.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>tbl <span class="ot">&lt;-</span> tidytext<span class="sc">::</span><span class="fu">unnest_tokens</span>(</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  janeaustenr<span class="sc">::</span><span class="fu">austen_books</span>(),</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  word, text, <span class="at">to_lower =</span> <span class="cn">FALSE</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>Austen<span class="sc">$</span>tokenstream <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(tbl)</span></code></pre></div>
<p>To demonstrate that we can use an additional positional attribute, we
stem the tokens using the <a href="https://CRAN.R-project.org/package=SnowballC">SnowballC</a>
package.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>Austen<span class="sc">$</span>tokenstream[, stem <span class="sc">:=</span> SnowballC<span class="sc">::</span><span class="fu">wordStem</span>(Austen<span class="sc">$</span>tokenstream[[<span class="st">&quot;word&quot;</span>]], <span class="at">language =</span> <span class="st">&quot;english&quot;</span>)]</span></code></pre></div>
<p>In this case, (zero-based!) corpus positions need to be assigned
explicitly.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>Austen<span class="sc">$</span>tokenstream[, cpos <span class="sc">:=</span> 0L<span class="sc">:</span>(<span class="fu">nrow</span>(tbl) <span class="sc">-</span> 1L)]</span></code></pre></div>
<p>We can now create (and inspect) the table with the structural
attributes.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>cpos_max_min <span class="ot">&lt;-</span> <span class="cf">function</span>(x)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">cpos_left =</span> <span class="fu">min</span>(x[[<span class="st">&quot;cpos&quot;</span>]]), <span class="at">cpos_right =</span> <span class="fu">max</span>(x[[<span class="st">&quot;cpos&quot;</span>]]))</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>Austen<span class="sc">$</span>metadata <span class="ot">&lt;-</span> Austen<span class="sc">$</span>tokenstream[, <span class="fu">cpos_max_min</span>(.SD), by <span class="ot">=</span> book]</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>Austen<span class="sc">$</span>metadata[, book <span class="sc">:=</span> <span class="fu">as.character</span>(book)]</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="fu">setcolorder</span>(Austen<span class="sc">$</span>metadata, <span class="fu">c</span>(<span class="st">&quot;cpos_left&quot;</span>, <span class="st">&quot;cpos_right&quot;</span>, <span class="st">&quot;book&quot;</span>))</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="fu">head</span>(Austen<span class="sc">$</span>tokenstream)</span></code></pre></div>
<pre><code>##                   book        word        stem  cpos
##                 &lt;fctr&gt;      &lt;char&gt;      &lt;char&gt; &lt;int&gt;
## 1: Sense &amp; Sensibility       SENSE       SENSE     0
## 2: Sense &amp; Sensibility         AND         AND     1
## 3: Sense &amp; Sensibility SENSIBILITY SENSIBILITi     2
## 4: Sense &amp; Sensibility          by          by     3
## 5: Sense &amp; Sensibility        Jane        Jane     4
## 6: Sense &amp; Sensibility      Austen      Austen     5</code></pre>
<p>A few finishing touches and we have the token stream ready to be
encoded: We remove the metadata from the table in the
<code>tokenstream</code> field and order the columns nicely.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>Austen<span class="sc">$</span>tokenstream[, book <span class="sc">:=</span> <span class="cn">NULL</span>]</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">setcolorder</span>(Austen<span class="sc">$</span>tokenstream, <span class="fu">c</span>(<span class="st">&quot;cpos&quot;</span>, <span class="st">&quot;word&quot;</span>, <span class="st">&quot;stem&quot;</span>))</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>Austen<span class="sc">$</span>tokenstream</span></code></pre></div>
<pre><code>##           cpos        word        stem
##          &lt;int&gt;      &lt;char&gt;      &lt;char&gt;
##      1:      0       SENSE       SENSE
##      2:      1         AND         AND
##      3:      2 SENSIBILITY SENSIBILITi
##      4:      3          by          by
##      5:      4        Jane        Jane
##     ---                               
## 725051: 725050          in          in
## 725052: 725051         its          it
## 725053: 725052    national      nation
## 725054: 725053  importance      import
## 725055: 725054       Finis        Fini</code></pre>
<p>Ready to encode the corpus!</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>Austen<span class="sc">$</span><span class="fu">encode</span>(</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>   <span class="at">corpus =</span> <span class="st">&quot;AUSTEN&quot;</span>,</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>   <span class="at">encoding =</span> <span class="st">&quot;utf8&quot;</span>,</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>   <span class="at">p_attributes =</span> <span class="fu">c</span>(<span class="st">&quot;word&quot;</span>, <span class="st">&quot;stem&quot;</span>),</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>   <span class="at">s_attributes =</span> <span class="st">&quot;book&quot;</span>,</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>   <span class="at">registry_dir =</span> registry_tmp,</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>   <span class="at">data_dir =</span> austen_data_dir_tmp,</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>   <span class="at">method =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>   <span class="at">compress =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>   <span class="at">reload =</span> <span class="cn">TRUE</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>)</span></code></pre></div>
<p>This is a rudimentary check (using low-level RcppCWB functions)
whether to corpus can be used. How often does the token “pride”
occur?</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>ids <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_str2id</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;AUSTEN&quot;</span>,</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="at">str =</span> <span class="st">&quot;pride&quot;</span>,</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>cpos <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_id2cpos</span>(</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;AUSTEN&quot;</span>,</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="at">id =</span> ids,</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>)</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="fu">length</span>(cpos)</span></code></pre></div>
<pre><code>## [1] 113</code></pre>
</div>
</div>
<div id="scenario-2-from-xml-to-cwb---un-general-assembly-corpus" class="section level2">
<h2>Scenario 2: From XML to CWB - UN General Assembly Corpus</h2>
<p>The second example is to turn a small sample corpus of debates in the
UN General Assembly into an indexed corpus. The package includes some
XML files that follow a standard suggested by the <a href="https://tei-c.org/">Text Encoding Initiative (TEI)</a>.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>teidir <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="at">package =</span> <span class="st">&quot;cwbtools&quot;</span>, <span class="st">&quot;xml&quot;</span>, <span class="st">&quot;UNGA&quot;</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>teifiles <span class="ot">&lt;-</span> <span class="fu">list.files</span>(teidir, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">list.files</span>(teidir)</span></code></pre></div>
<pre><code>## [1] &quot;N9986497.xml&quot; &quot;N9986515.xml&quot; &quot;N9986521.xml&quot; &quot;N9986551.xml&quot; &quot;N9986557.xml&quot;
## [6] &quot;N9986569.xml&quot; &quot;N9986587.xml&quot;</code></pre>
<p>For our example, we need an (empty) data directory for the UNGA
corpus.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>unga_data_dir_tmp <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(data_dir_tmp, <span class="st">&quot;unga&quot;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(unga_data_dir_tmp)) <span class="fu">dir.create</span>(unga_data_dir_tmp)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="fu">file.remove</span>(<span class="fu">list.files</span>(unga_data_dir_tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<p>The point of departure then is to create a <code>CorpusData</code>
object that will serve as a processor for these files and storage
facility for the corpus data. The central fields of the class are named
<code>chunktable</code>, <code>tokenstream</code> and
<code>metadata</code>. When we inspect the new object at the outset, we
will see that these fields are not filled initially.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>UNGA <span class="ot">&lt;-</span> CorpusData<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>UNGA</span></code></pre></div>
<pre><code>## chunktable: NULL
## tokenstream: NULL
## metadata: NULL</code></pre>
<p>To turn the XML files into the
<code>CorpusData object, we use the method</code>$import_xml()`. To be
able to add metadata from the header to the metadata table, the method
requires a named vector of XPath expressions used to find the metadata
within the XML document.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>metadata <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  <span class="at">doc_lp =</span> <span class="st">&quot;//legislativePeriod&quot;</span>,</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="at">doc_session =</span> <span class="st">&quot;//titleStmt/sessionNo&quot;</span>,</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>  <span class="at">doc_date =</span> <span class="st">&quot;//publicationStmt/date&quot;</span>,</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>  <span class="at">doc_url =</span> <span class="st">&quot;//sourceDesc/url&quot;</span>,</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  <span class="at">doc_src =</span> <span class="st">&quot;//sourceDesc/filetype&quot;</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>UNGA<span class="sc">$</span><span class="fu">import_xml</span>(<span class="at">filenames =</span> teifiles, <span class="at">meta =</span> metadata)</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>UNGA</span></code></pre></div>
<pre><code>## chunktable: 2 columns / 1148 rows
## tokenstream: NULL
## metadata: 20 columns / 1148 rows</code></pre>
<p>The input XML files are TEI files. Speaker information is included in
the attributes of a tag named ‘sp’. To maintain the original content,
there is a element ‘speaker’ in the document that includes the
information on the speaker call without having parsed it. It is not text
spoken in the debate, so we consider it as noise to be removed.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>to_keep <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">is.na</span>(UNGA<span class="sc">$</span>metadata[[<span class="st">&quot;speaker&quot;</span>]]))</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>UNGA<span class="sc">$</span>chunktable <span class="ot">&lt;-</span> UNGA<span class="sc">$</span>chunktable[to_keep]</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>UNGA<span class="sc">$</span>metadata <span class="ot">&lt;-</span> UNGA<span class="sc">$</span>metadata[to_keep][, speaker <span class="sc">:=</span> <span class="cn">NULL</span>]</span></code></pre></div>
<p>The CWB requires a tokenstream as input to generate positional
attributes. NLP tools will offer lemmatization,
part-of-speech-recognition and more. To keep things simple, we perform a
very simple tokenization that relies on the <a href="https://CRAN.R-project.org/package=tokenizers">tokenizers</a>
package.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>UNGA<span class="sc">$</span><span class="fu">tokenize</span>(<span class="at">lowercase =</span> <span class="cn">FALSE</span>, <span class="at">strip_punct =</span> <span class="cn">FALSE</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>UNGA</span></code></pre></div>
<p>Let us see how it looks like now …</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>UNGA<span class="sc">$</span>tokenstream</span></code></pre></div>
<pre><code>##            id   word   cpos
##         &lt;int&gt; &lt;char&gt;  &lt;int&gt;
##      1:     2      I      0
##      2:     2 should      1
##      3:     2   like      2
##      4:     2     to      3
##      5:     2 inform      4
##     ---                    
## 127078:  1148   rose 127077
## 127079:  1148     at 127078
## 127080:  1148      1 127079
## 127081:  1148    p.m 127080
## 127082:  1148      . 127081</code></pre>
<p>The <code>CorpusData</code> object now includes a table with the
token stream, and we are ready to import the corpus into the CWB. We use
the <code>$encode()</code> method for this purpose. Note that the
workers are the <code>p_attribute_encode</code> function (to encode the
token stream), and the <code>s_attribute_encode</code> function (to
encode the structural attributes / the metadata).</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>UNGA<span class="sc">$</span><span class="fu">encode</span>(</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  <span class="at">registry_dir =</span> registry_tmp,</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="at">data_dir =</span> unga_data_dir_tmp,</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;UNGA&quot;</span>,</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>  <span class="at">encoding =</span> <span class="st">&quot;utf8&quot;</span>,</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="at">p_attributes =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="at">s_attributes =</span> <span class="fu">c</span>(</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>    <span class="st">&quot;doc_lp&quot;</span>, <span class="st">&quot;doc_session&quot;</span>, <span class="st">&quot;doc_date&quot;</span>,</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>    <span class="st">&quot;sp_who&quot;</span>, <span class="st">&quot;sp_state&quot;</span>, <span class="st">&quot;sp_role&quot;</span></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>  ),</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">FALSE</span></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>)</span></code></pre></div>
<p>In this example, the logical parameter <code>compress</code> is
<code>FALSE</code>. If <code>TRUE</code>, a so-called “huffcode””
compression if performed., which will reduce corpus size and speed up
queries. For big corpora, compression makes sense, but it can be
time-consuming. If you want to create a corpus experimentally and do not
yet need optimization, performing the compression can be postponed or
omitted.</p>
<p>The indexed corpus has now been prepared and can be used with CQP,
CQPweb, or – if you like R – with a package such as <a href="https://CRAN.R-project.org/package=polmineR">polmineR</a>. To see
quickly whether everything has worked out as intended (and to keep
installation requirements at a minimum), we use the low-level
functionality of the <a href="https://CRAN.R-project.org/package=RcppCWB">RcppCWB</a>
package.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>id_peace <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_str2id</span>(</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;UNGA&quot;</span>,</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>  <span class="at">str =</span> <span class="st">&quot;peace&quot;</span>,</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a>cpos_peace <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_id2cpos</span>(</span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;UNGA&quot;</span>,</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a>  <span class="at">id =</span> id_peace,</span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>)</span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>  <span class="at">i =</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(cpos_peace), <span class="cf">function</span>(x) <span class="fu">rep</span>(x, <span class="at">times =</span> <span class="dv">11</span>))),</span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a>  <span class="at">cpos =</span> <span class="fu">unlist</span>(<span class="fu">lapply</span>(cpos_peace, <span class="cf">function</span>(x) (x <span class="sc">-</span> <span class="dv">5</span>)<span class="sc">:</span>(x <span class="sc">+</span> <span class="dv">5</span>)))</span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>  )</span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a>tab[[<span class="st">&quot;id&quot;</span>]] <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_cpos2id</span>(</span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;UNGA&quot;</span>, <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>  <span class="at">cpos =</span> tab[[<span class="st">&quot;cpos&quot;</span>]], <span class="at">registry =</span> registry_tmp</span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>)</span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>tab[[<span class="st">&quot;str&quot;</span>]] <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_id2str</span>(</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;UNGA&quot;</span>, <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>  <span class="at">id =</span> tab[[<span class="st">&quot;id&quot;</span>]], <span class="at">registry =</span> registry_tmp</span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>)</span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>peace_context <span class="ot">&lt;-</span> <span class="fu">split</span>(tab[[<span class="st">&quot;str&quot;</span>]], <span class="fu">as.factor</span>(tab[[<span class="st">&quot;i&quot;</span>]]))</span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a>peace_context <span class="ot">&lt;-</span> <span class="fu">unname</span>(<span class="fu">sapply</span>(peace_context, <span class="cf">function</span>(x) <span class="fu">paste</span>(x, <span class="at">collapse =</span> <span class="st">&quot; &quot;</span>)))</span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a><span class="fu">head</span>(peace_context)</span></code></pre></div>
<pre><code>## [1] &quot;the breast of a tranquil peace for all of the world&quot;                         
## [2] &quot;earth in the rapture of peace , justice and safety .&quot;                        
## [3] &quot;community are committed to achieving peace , security and prosperity for&quot;    
## [4] &quot;components of post - conflict peace - building , given the&quot;                  
## [5] &quot;removal and the consolidation of peace and mutual trust between neighbouring&quot;
## [6] &quot;and the promotion of durable peace and sustainable development in Africa&quot;</code></pre>
<div id="scenario-3-from-tm-package-vcorpus-to-cwb" class="section level3">
<h3>Scenario 3: From tm-package VCorpus to CWB</h3>
<p>In the third scenario, we will make the transition from a
<code>VCorpus</code> (tm package) to a CWB indexed corpus. We use the
Reuters corpus that is included as sample data in the tm package.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">library</span>(tm)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>reut21578 <span class="ot">&lt;-</span> <span class="fu">system.file</span>(<span class="st">&quot;texts&quot;</span>, <span class="st">&quot;crude&quot;</span>, <span class="at">package =</span> <span class="st">&quot;tm&quot;</span>)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>reuters.tm <span class="ot">&lt;-</span> <span class="fu">VCorpus</span>(</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>  <span class="fu">DirSource</span>(reut21578),</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">reader =</span> readReut21578XMLasPlain)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>)</span></code></pre></div>
<p>A quick way to attain the data format required for the
<code>CorpusData</code> class is to coerce the <code>VCorpus</code> to a
<code>tibble</code>, using respective functionality of the <a href="https://CRAN.R-project.org/package=tidytext">tidytext</a>
package.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>reuters.tbl <span class="ot">&lt;-</span> <span class="fu">tidy</span>(reuters.tm)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>reuters.tbl</span></code></pre></div>
<pre><code>## # A tibble: 20 × 17
##    author   datetimestamp       description heading id    language origin topics
##    &lt;chr&gt;    &lt;dttm&gt;              &lt;chr&gt;       &lt;chr&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;chr&gt;  &lt;chr&gt; 
##  1 &lt;NA&gt;     1987-02-26 17:00:56 &quot;&quot;          DIAMON… 127   en       Reute… YES   
##  2 BY TED … 1987-02-26 17:34:11 &quot;&quot;          OPEC M… 144   en       Reute… YES   
##  3 &lt;NA&gt;     1987-02-26 18:18:00 &quot;&quot;          TEXACO… 191   en       Reute… YES   
##  4 &lt;NA&gt;     1987-02-26 18:21:01 &quot;&quot;          MARATH… 194   en       Reute… YES   
##  5 &lt;NA&gt;     1987-02-26 19:00:57 &quot;&quot;          HOUSTO… 211   en       Reute… YES   
##  6 &lt;NA&gt;     1987-03-01 03:25:46 &quot;&quot;          KUWAIT… 236   en       Reute… YES   
##  7 By Jere… 1987-03-01 03:39:14 &quot;&quot;          INDONE… 237   en       Reute… YES   
##  8 &lt;NA&gt;     1987-03-01 05:27:27 &quot;&quot;          SAUDI … 242   en       Reute… YES   
##  9 &lt;NA&gt;     1987-03-01 08:22:30 &quot;&quot;          QATAR … 246   en       Reute… YES   
## 10 &lt;NA&gt;     1987-03-01 18:31:44 &quot;&quot;          SAUDI … 248   en       Reute… YES   
## 11 &lt;NA&gt;     1987-03-02 01:05:49 &quot;&quot;          SAUDI … 273   en       Reute… YES   
## 12 &lt;NA&gt;     1987-03-02 07:39:23 &quot;&quot;          GULF A… 349   en       Reute… YES   
## 13 &lt;NA&gt;     1987-03-02 07:43:22 &quot;&quot;          SAUDI … 352   en       Reute… YES   
## 14 &lt;NA&gt;     1987-03-02 07:43:41 &quot;&quot;          KUWAIT… 353   en       Reute… YES   
## 15 &lt;NA&gt;     1987-03-02 08:25:42 &quot;&quot;          PHILAD… 368   en       Reute… YES   
## 16 &lt;NA&gt;     1987-03-02 11:20:05 &quot;&quot;          STUDY … 489   en       Reute… YES   
## 17 &lt;NA&gt;     1987-03-02 11:28:26 &quot;&quot;          STUDY … 502   en       Reute… YES   
## 18 &lt;NA&gt;     1987-03-02 12:13:46 &quot;&quot;          UNOCAL… 543   en       Reute… YES   
## 19 By BERN… 1987-03-02 14:38:34 &quot;&quot;          NYMEX … 704   en       Reute… YES   
## 20 &lt;NA&gt;     1987-03-02 14:49:06 &quot;&quot;          ARGENT… 708   en       Reute… YES   
## # ℹ 9 more variables: lewissplit &lt;chr&gt;, cgisplit &lt;chr&gt;, oldid &lt;chr&gt;,
## #   topics_cat &lt;named list&gt;, places &lt;named list&gt;, people &lt;chr&gt;, orgs &lt;chr&gt;,
## #   exchanges &lt;chr&gt;, text &lt;chr&gt;</code></pre>
<p>Columns with the metadata we may want to encode are still character
vectors (length &gt; 1). We turn the columns with the topic
categorizations and the places into length-one character vectors.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>topics <span class="ot">&lt;-</span> <span class="fu">sapply</span>(reuters.tbl[[<span class="st">&quot;topics_cat&quot;</span>]], paste, <span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>places <span class="ot">&lt;-</span> <span class="fu">sapply</span>(reuters.tbl[[<span class="st">&quot;places&quot;</span>]], paste, <span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>)</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>reuters.tbl[[<span class="st">&quot;topics&quot;</span>]] <span class="ot">&lt;-</span> topics</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>reuters.tbl[[<span class="st">&quot;places&quot;</span>]] <span class="ot">&lt;-</span> places</span></code></pre></div>
<p>This is the input we need. We instantiate a <code>CorpusData</code>
object end make sure that a new data directory for the REUTERS corpus
exists (and is empty) …</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>Reuters <span class="ot">&lt;-</span> CorpusData<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>reuters_data_dir_tmp <span class="ot">&lt;-</span> fs<span class="sc">::</span><span class="fu">path</span>(data_dir_tmp, <span class="st">&quot;reuters&quot;</span>)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(reuters_data_dir_tmp)) <span class="fu">dir.create</span>(reuters_data_dir_tmp)</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="fu">file.remove</span>(<span class="fu">list.files</span>(reuters_data_dir_tmp, <span class="at">full.names =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<p>We assign the chunktable and the metadata, coerced to a
<code>data.table</code>, to the object …</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>Reuters<span class="sc">$</span>chunktable <span class="ot">&lt;-</span> <span class="fu">data.table</span>(reuters.tbl[, <span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;text&quot;</span>)])</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>Reuters<span class="sc">$</span>metadata <span class="ot">&lt;-</span> <span class="fu">data.table</span>(reuters.tbl[,<span class="fu">c</span>(<span class="st">&quot;id&quot;</span>, <span class="st">&quot;topics&quot;</span>, <span class="st">&quot;places&quot;</span>)])</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>Reuters</span></code></pre></div>
<pre><code>## chunktable: 2 columns / 20 rows
## tokenstream: NULL
## metadata: 3 columns / 20 rows</code></pre>
<p>… we tokenize the text to gain the token stream table …</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>Reuters<span class="sc">$</span><span class="fu">tokenize</span>()</span></code></pre></div>
<p>… we have a look at the token stream …</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>Reuters<span class="sc">$</span>tokenstream</span></code></pre></div>
<pre><code>##           id         word  cpos
##       &lt;char&gt;       &lt;char&gt; &lt;int&gt;
##    1:    127      diamond     0
##    2:    127     shamrock     1
##    3:    127         corp     2
##    4:    127         said     3
##    5:    127         that     4
##   ---                          
## 4046:    708  yacimientos  4045
## 4047:    708 petroliferos  4046
## 4048:    708     fiscales  4047
## 4049:    708        added  4048
## 4050:    708       reuter  4049</code></pre>
<p>It seems that we can encode the corpus.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>Reuters<span class="sc">$</span><span class="fu">encode</span>(</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>   <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>   <span class="at">encoding =</span> <span class="st">&quot;utf8&quot;</span>,</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>   <span class="at">p_attributes =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>   <span class="at">s_attributes =</span> <span class="fu">c</span>(<span class="st">&quot;topics&quot;</span>, <span class="st">&quot;places&quot;</span>),</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>   <span class="at">registry_dir =</span> registry_tmp,</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>   <span class="at">data_dir =</span> reuters_data_dir_tmp,</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>   <span class="at">method =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>   <span class="at">compress =</span> <span class="cn">FALSE</span></span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a>)</span></code></pre></div>
<p>The REUTERS corpus is about oil production in the Middle East. To
check quickly, whether it works, we count the number of occurrences of
the word “oil”.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>ids <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_str2id</span>(</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>  <span class="at">str =</span> <span class="st">&quot;oil&quot;</span>,</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>)</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>cpos <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_id2cpos</span>(</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a>  <span class="at">id =</span> ids,</span>
<span id="cb40-12"><a href="#cb40-12" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp</span>
<span id="cb40-13"><a href="#cb40-13" tabindex="-1"></a>)</span>
<span id="cb40-14"><a href="#cb40-14" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" tabindex="-1"></a><span class="fu">length</span>(cpos)</span></code></pre></div>
<pre><code>## [1] 86</code></pre>
</div>
<div id="scenario-4-add-word-stems-to-existing-corpus" class="section level3">
<h3>Scenario 4: Add word stems to existing corpus</h3>
<p>Finally, we show how to add a further p-attribute to an existing
corpus, using the REUTERS corpus we just created.</p>
<p>The initial step here is to decode the entire token stream. It could
be done easily using <code>polmineR::get_token_stream()</code>, but to
avoid creating a further dependency, we use basic RcppCWB
functionality.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>reuters_size <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">attribute_size</span>(</span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp,</span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>  <span class="at">attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>  <span class="at">attribute_type =</span> <span class="st">&quot;p&quot;</span></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a>)</span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a>ids <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_cpos2id</span>(</span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp,</span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a>  <span class="at">cpos =</span> 0L<span class="sc">:</span>(reuters_size <span class="sc">-</span> 1L)</span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a>)</span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a></span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a>token_stream <span class="ot">&lt;-</span> RcppCWB<span class="sc">::</span><span class="fu">cl_id2str</span>(</span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a>  <span class="at">registry =</span> registry_tmp,</span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;word&quot;</span>,</span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a>  <span class="at">id =</span> ids</span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a>)</span></code></pre></div>
<p>We then generate the stemmed token stream …</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>stemmed <span class="ot">&lt;-</span> SnowballC<span class="sc">::</span><span class="fu">wordStem</span>(token_stream, <span class="at">language =</span> <span class="st">&quot;en&quot;</span>)</span></code></pre></div>
<p>… and add this to the corpus.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">p_attribute_encode</span>(</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>  <span class="at">token_stream =</span> stemmed,</span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>  <span class="at">p_attribute =</span> <span class="st">&quot;stem&quot;</span>,</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>  <span class="at">encoding =</span> <span class="st">&quot;utf8&quot;</span>,</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>  <span class="at">corpus =</span> <span class="st">&quot;REUTERS&quot;</span>,</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>  <span class="at">registry_dir =</span> registry_tmp,</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a>  <span class="at">data_dir =</span> reuters_data_dir_tmp,</span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a>  <span class="at">method =</span> <span class="st">&quot;R&quot;</span>,</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span>,</span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a>  <span class="at">quietly =</span> <span class="cn">TRUE</span>,</span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a>  <span class="at">compress =</span> <span class="cn">FALSE</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>## ℹ creating indices (in memory)</code></pre>
<pre><code>## ✔ creating indices (in memory) [93ms]</code></pre>
<pre><code>## </code></pre>
<pre><code>## ℹ writing file: &#39;stem.corpus&#39;</code></pre>
<pre><code>## ✔ writing file: &#39;stem.corpus&#39; [272ms]</code></pre>
<pre><code>## </code></pre>
<pre><code>## ℹ writing file: &#39;stem.lexicon&#39;</code></pre>
<pre><code>## ✔ writing file: &#39;stem.lexicon&#39; [9ms]</code></pre>
<pre><code>## </code></pre>
<pre><code>## ℹ writing file: &#39;stem.lexicon.idx&#39;</code></pre>
<pre><code>## ✔ writing file: &#39;stem.lexicon.idx&#39; [8ms]</code></pre>
<pre><code>## </code></pre>
<pre><code>## ℹ updating registry file: &#39;/var/folders/fw/qwt11pjx1qs83dl2jwltcvmr0000gn/T/RtmpsdN2Zp/registry/reuters&#39;</code></pre>
<pre><code>## ℹ run `Rcpp::cwb_makeall()`</code></pre>
<pre><code>## ✔ run `Rcpp::cwb_makeall()` [4ms]</code></pre>
<pre><code>## </code></pre>
<pre><code>## ✔ corpus reloaded: CL success / CQP success</code></pre>
<p>This is a very basic demo: Obviously, you could use more advanced NLP
tools to generate a part-of-speech annotation, lemmatization etc, and
add it to an existing corpus.</p>
</div>
<div id="cleaning-up" class="section level3">
<h3>Cleaning up</h3>
<p>As a matter of housekeeping, we remove the temporary directories.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="fu">unlink</span>(registry_tmp, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a><span class="fu">unlink</span>(data_dir_tmp, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Hope everything works! Enjoy! Feedback is welcome!</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
